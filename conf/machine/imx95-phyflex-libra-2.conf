#@TYPE: Machine
#@NAME: imx95-phyflex-libra-2
#@DESCRIPTION: PHYTEC Libra phyFLEX-i.MX 95 FPSC, 8 GB RAM, e.MMC, silicon revision B0
#@ARTICLENUMBERS: PD-05032-001.A2

MACHINEOVERRIDES =. "mx95:phyflex-fpsc-g:libra:imx95-phyflex-libra:"

include conf/machine/include/imx-base.inc
require conf/machine/include/partup-layout-config.inc
require conf/machine/include/phytec-machine-common.inc

# Common settings for PHYTEC's i.MX95 boards
require conf/machine/include/arm/armv8-2a/tune-cortexa55.inc

MACHINE_FEATURES += "bluetooth can caam emmc gpu pci screen serial tpm2 wifi"
PREFERRED_PROVIDER_virtual/bootloader = "u-boot-master"
PREFERRED_PROVIDER_virtual/bootloader:use-nxp-bsp = "u-boot-phytec-imx"
PREFERRED_PROVIDER_virtual/kernel = "linux-yocto-dev"
PREFERRED_PROVIDER_virtual/kernel:use-nxp-bsp = "linux-phytec-imx"
PREFERRED_PROVIDER_virtual/imx-system-manager = "imx-sm-phytec"
PREFERRED_PROVIDER_virtual/imx-oei = "imx-oei-phytec"
SYSTEM_MANAGER_RPROVIDER:use-nxp-bsp = "imx-sm-phytec"

# Don't install kernelimage to rootfs
RRECOMMENDS:${KERNEL_PACKAGE_NAME}-base = ""

IMAGE_CLASSES += "wic-helper image-types-partup"
IMAGE_CLASSES:append:mx95-nxp-bsp = " wic-bootenv-helper"
IMAGE_FSTYPES = "tar.gz wic.bmap wic.xz partup"
IMAGE_FSTYPES:update = "partup"
WKS_FILES ?= "imx9-sdimage.wks"
WKS_BOOTIMAGESIZE ?= "64"

# MMC user area bootloader image offset
BOOTLOADER_SEEK ?= "32"
# eMMC boot partition bootloader image offset
BOOTLOADER_SEEK_EMMC ?= "0"
# Device information used by RAUC and some of its dependencies
EMMC_DEV ?= "0"

IMAGE_BOOT_FILES = "fitImage boot.scr.uimg"
IMAGE_BOOT_FILES:use-nxp-bsp = "fitImage overlays.txt boot.scr.uimg"
IMAGE_BOOT_FILES:secureboot:mx95-nxp-bsp = "fitImage overlays.txt"
# Used only for NXP BSP
IMAGE_BOOTLOADER = "imx-boot"

INITRAMFS_MAXSIZE = "262144"

# Set Serial console
SERIAL_CONSOLES = "115200;ttyLP3"

# Set ATF platform name
ATF_PLATFORM = "imx95"
# for trusted-firmware-a
TFA_PLATFORM = "${ATF_PLATFORM}"
ATF_BOOT_UART_BASE = "0x42690000"

OEI_CONFIGS = "ddr tcm"
OEI_CORE = "m33"
OEI_SOC = "mx95"
OEI_BOARD = "mx95libra"

SYSTEM_MANAGER_CONFIG = "mx95libra"
SYSTEM_MANAGER_FIRMWARE_BASENAME = "m33_image"
SYSTEM_MANAGER_FIRMWARE_NAME = "${SYSTEM_MANAGER_FIRMWARE_BASENAME}"

# Set DDR FIRMWARE
DDR_FIRMWARE_NAME = " \
    lpddr5_dmem_qb_v202409.bin \
    lpddr5_dmem_v202409.bin \
    lpddr5_imem_qb_v202409.bin \
    lpddr5_imem_v202409.bin \
"
DDR_TYPE   = "lpddr5"

SPL_BINARY = "spl/u-boot-spl.bin"
UBOOT_ARCH = "arm64"
# NXP bastardizes this variable to contain the U-Boot proper only. Set for mainline only.
UBOOT_BINARY:use-mainline-bsp = "flash.bin"
UBOOT_CONFIG ??= "sd"
UBOOT_CONFIG[sd]   = "${UBOOT_CONFIG_BASENAME}_defconfig,sdcard"
UBOOT_CONFIG_BASENAME = "imx95-phyflex-libra-rdk"
UBOOT_DTB_LOADADDRESS = "0xD9000000"
UBOOT_DTB_NAME = "imx95-phyflex-libra-rdk.dtb"
UBOOT_DTBO_LOADADDRESS = "0xD9100000"
UBOOT_ENTRYPOINT = "0xD0000000"
UBOOT_MAKE_TARGET = ""
UBOOT_PROVIDES_BOOT_CONTAINER = "1"
UBOOT_PROVIDES_BOOT_CONTAINER:use-nxp-bsp = "0"
UBOOT_SUFFIX = "bin"

IMX_BOOT_SOC_TARGET = "iMX95"
IMX_BOOT_SEEK = "32"
IMX_DEFAULT_BOOTLOADER = "u-boot-phytec-imx"
# NXP uses mx95-nxp-bsp override, so we have to use it, too (see imx-base-extend.inc)
IMX_EXTRA_FIRMWARE:mx95-nxp-bsp += "imx-oei-phytec"
IMX_EXTRA_FIRMWARE:mx95-nxp-bsp:remove = "imx-oei"
IMX_SOC_REV = "B0"
IMXBOOT_TARGETS = "flash_a55"

EXTERNAL_KERNEL_DEVICETREE ??= ""
KERNEL_CLASSES += "kernel-fitimage"
KERNEL_IMAGETYPES += "fitImage"
KERNEL_DEVICETREE = " \
    freescale/imx95-phyflex-libra-rdk.dtb \
    freescale/imx95-phyflex-libra-rdk-lvds-ph128800t006-zhc01.dtbo \
    freescale/imx95-phyflex-libra-rdk-neoisp.dtbo \
    freescale/imx95-phyflex-libra-rdk-peb-av-10-ph128800t006-zhc01.dtbo \
    freescale/imx95-phyflex-libra-rdk-peb-av-10.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm016-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm016-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm016-fpdlink-port0-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm016-fpdlink-port0-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm016-fpdlink-port1-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm016-fpdlink-port1-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm017-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm017-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm017-fpdlink-port0-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm017-fpdlink-port0-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm017-fpdlink-port1-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm017-fpdlink-port1-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm020-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm020-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm020-fpdlink-port0-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm020-fpdlink-port0-csi2.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm020-fpdlink-port1-csi1.dtbo \
    freescale/imx95-phyflex-libra-rdk-vm020-fpdlink-port1-csi2.dtbo \
"

# This variable needs to be set for imx-boot recipe from nxp, image does not get built into imx-boot
M4_DEFAULT_IMAGE_MX95 = "imx95-19x19-evk_m7_TCM_power_mode_switch.bin"
